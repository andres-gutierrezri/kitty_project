{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/dashboard.css' %}">
{% endblock %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 dashboard-sidebar">
            <div class="user-profile-card">
                {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="Avatar" class="user-avatar">
                {% else %}
                <div class="user-avatar-placeholder">
                    <i class="fas fa-user fa-3x"></i>
                </div>
                {% endif %}
                <h4 class="mt-3">{{ user.get_full_name_or_username }}</h4>
                <p class="text-muted">@{{ user.username }}</p>
                <span class="badge bg-primary">{{ user.get_role_display }}</span>
            </div>
            
            <div class="dashboard-menu mt-4">
                <a href="{% url 'accounts:dashboard' %}" class="menu-item active">
                    <i class="fas fa-home"></i> Panel Principal
                </a>
                <a href="{% url 'accounts:profile' %}" class="menu-item">
                    <i class="fas fa-user-edit"></i> Editar Perfil
                </a>
                {% if user.is_admin or user.is_superuser %}
                <a href="{% url 'accounts:admin_dashboard' %}" class="menu-item">
                    <i class="fas fa-cog"></i> Administración
                </a>
                <a href="{% url 'accounts:user_list' %}" class="menu-item">
                    <i class="fas fa-users"></i> Usuarios
                </a>
                {% endif %}
                <a href="{% url 'accounts:logout' %}" class="menu-item text-danger">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="dashboard-header">
                <h2>¡Bienvenido, {{ user.first_name }}!</h2>
                <p class="text-muted">Este es tu panel de usuario</p>
            </div>
            
            {% if messages %}
            <div class="messages-container mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-warning">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ user_stats.total_reviews }}</h3>
                            <p>Reseñas</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-danger">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ user_stats.total_favorites }}</h3>
                            <p>Favoritos</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-success">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ cart_total }}</h3>
                            <p>En Carrito</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-info">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="stat-content">
                            <h3>{{ user_stats.unread_notifications }}</h3>
                            <p>Notificaciones</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt"></i> Accesos Rápidos
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <a href="{% url 'productos:my_favorites' %}" class="btn btn-outline-danger w-100">
                                        <i class="fas fa-heart"></i> Mis Favoritos
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'productos:my_reviews' %}" class="btn btn-outline-warning w-100">
                                        <i class="fas fa-star"></i> Mis Reseñas
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'productos:view_cart' %}" class="btn btn-outline-success w-100">
                                        <i class="fas fa-shopping-cart"></i> Mi Carrito
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'productos:my_activity' %}" class="btn btn-outline-info w-100">
                                        <i class="fas fa-history"></i> Mi Actividad
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activities & Notifications -->
            <div class="row mb-4">
                <!-- Recent Activities -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history"></i> Actividad Reciente
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            {% if recent_activities %}
                                {% for activity in recent_activities %}
                                <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                                    <div class="me-3">
                                        {% if activity.activity_type == 'view' %}
                                            <i class="fas fa-eye text-info"></i>
                                        {% elif activity.activity_type == 'review' %}
                                            <i class="fas fa-star text-warning"></i>
                                        {% elif activity.activity_type == 'favorite' %}
                                            <i class="fas fa-heart text-danger"></i>
                                        {% elif activity.activity_type == 'cart_add' %}
                                            <i class="fas fa-cart-plus text-success"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <small class="text-muted d-block">{{ activity.created_at|timesince }} atrás</small>
                                        <p class="mb-0 small">{{ activity.description }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                                <a href="{% url 'productos:my_activity' %}" class="btn btn-sm btn-outline-primary w-100">
                                    Ver toda la actividad
                                </a>
                            {% else %}
                                <p class="text-muted text-center mb-0">No hay actividad reciente</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Recent Notifications -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bell"></i> Notificaciones
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            {% if recent_notifications %}
                                {% for notification in recent_notifications %}
                                <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                                    <div class="me-3">
                                        {% if notification.notification_type == 'new_product' %}
                                            <i class="fas fa-box-open text-success"></i>
                                        {% elif notification.notification_type == 'price_drop' %}
                                            <i class="fas fa-tag text-danger"></i>
                                        {% else %}
                                            <i class="fas fa-info-circle text-info"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <small class="text-muted d-block">{{ notification.created_at|timesince }} atrás</small>
                                        <strong class="d-block">{{ notification.title }}</strong>
                                        <p class="mb-0 small">{{ notification.message|truncatewords:15 }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                                <a href="{% url 'productos:my_notifications' %}" class="btn btn-sm btn-outline-primary w-100">
                                    Ver todas las notificaciones
                                </a>
                            {% else %}
                                <p class="text-muted text-center mb-0">No hay notificaciones nuevas</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Login Activity -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> Actividad Reciente
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_logins %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Dirección IP</th>
                                    <th>Navegador</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for login in recent_logins %}
                                <tr>
                                    <td>{{ login.login_time|date:"d/m/Y H:i:s" }}</td>
                                    <td>{{ login.ip_address }}</td>
                                    <td class="text-truncate" style="max-width: 200px;">{{ login.user_agent|default:"N/A" }}</td>
                                    <td>
                                        {% if login.success %}
                                        <span class="badge bg-success">Exitoso</span>
                                        {% else %}
                                        <span class="badge bg-danger">Fallido</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay actividad reciente</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'accounts/js/dashboard.js' %}"></script>
{% endblock %}
